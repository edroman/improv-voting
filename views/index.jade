// The main homepage

extends layout

block content

	#loading Loading Stories...
	#no-more No More Stories
	leftCol
		b
			u Most Recent Stories

		// Populate content with initial dataset loaded from controller.
		- recentGames.forEach( function(game) {
			br
			br
			b
				a(href='/stories/#{game.id}') By #{game.get("creator").get("name")} and #{game.get("invitee").get("name")}
			br
			- game.turns.each( function(turn) {
			= turn.get("turn");
			- });
			p #{game.get("votes")} votes
			p
			a(href='/vote/#{game.id}') Vote on this story!
			p
				// Tweet code
				// a(href='https://twitter.com/share',class='twitter-share-button',data-lang="en",data-count="none",data-related="xbox:Ghostfire Games",data-text="Check out this fun story! #atalltale",data-url="http://edro.no-ip.org:3000/stories/#{game.id}") Tweet
				
				// Facebook Like button
				.fb-like(data-href="http://edro.no-ip.org:3000/stories/b#{game.id}",layout="box_count", data-send="false", data-width="450", data-show-faces="false")				

				p

				// Facebook share code
				a(href='#',class='post_wall',name='Check out this tall tale!',caption='Made by #{game.get("creator").get("name")} and #{game.get("invitee").get("name")} on http://www.ATallTale.com') Share on Facebook
			p
		- });
	rightCol
		b
			u Other Interesting Stories

		// Populate content with initial dataset loaded from controller.
		- otherGames.forEach( function(game) {
			br
			br
			b
				a(href='/stories/#{game.id}') By #{game.get("creator").get("name")} and #{game.get("invitee").get("name")}
			br
			- game.turns.each( function(turn) {
			= turn.get("turn");
			- });
			p #{game.get("votes")} votes
			p
			a(href='/vote/#{game.id}') Vote on this story!
			p
				// Tweet code
				// a(href='https://twitter.com/share',class='twitter-share-button',data-lang="en",data-count="none",data-related="xbox:Ghostfire Games",data-text="Check out this fun story! #atalltale",data-url="http://edro.no-ip.org:3000/stories/#{game.id}") Tweet
				
				// Facebook Like button
				.fb-like(data-href="http://edro.no-ip.org:3000/stories/b#{game.id}",layout="box_count", data-send="false", data-width="450", data-show-faces="false")				

				p

				// Facebook share code
				a(href='#',class='post_wall',name='Check out this tall tale!',caption='Made by #{game.get("creator").get("name")} and #{game.get("invitee").get("name")} on http://www.ATallTale.com') Share on Facebook
			p
		- });

	// Infinite Scroll code
	script(type="text/javascript")
		var pagesRequested = 0;
		var pagesRetrieved = 0;
		
		$(window).scroll(function ()
		{
			var moreStoriesToRequest = ( (pagesRequested+1) * !{STORIES_PER_PAGE} <= !{totalGameCount});
			var moreStoriesToRetrieve = ( (pagesRetrieved+1) * !{STORIES_PER_PAGE} <= !{totalGameCount});

			// scrollTop() gives us the number of pixels down from the top of the page we are scrolled
			var nearBottom = ($(window).scrollTop() + $(window).height() > $(document).height() - 200);

			// By default, hide the "loading" and "no more" elements which the user sees if they're at the bottom
			$('#loading').hide();
			$('#no-more').hide();
		
			// If we're near the bottom of the screen..
			if (nearBottom)
			{
				// If there's more content to load...
				if (moreStoriesToRequest)
				{
					// Show the "loading" element
					$('#loading').css("top","400");
					$('#loading').show();

					// Perform an AJAX call to load more -- only if we're not waiting for more data from the server from a previous call
					if (pagesRequested == pagesRetrieved)
					{
						// Increment the page we're on
						pagesRequested++;
						
						// Do an AJAX call to retrieve more content
						$.ajax({
							type: "GET",
							url: "stories-ajax",
							data: { page_num : pagesRequested }
						}).done( function(msg) {
							$("leftCol").append(msg);
							console.log(msg);
							pagesRetrieved++;
	
							// Re-hide the "loading" and "no more" elements which the user sees if they're at the bottom
							$('#loading').hide();
							$('#no-more').hide();
						});
					}
				}
				else if (moreStoriesToRetrieve)
				{
					// Show the "loading" element
					$('#loading').css("top","400");
					$('#loading').show();
				}
				// Otherwise we're on the final page, so display "no more stories"
				else
				{
					$('#no-more').css("top","400");
					$('#no-more').show();
				}
			}
		});
